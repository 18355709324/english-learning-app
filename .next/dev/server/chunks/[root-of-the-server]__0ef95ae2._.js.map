{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/yanchong/Desktop/english-sentence-app/app/api/generate-sentences/route.ts"],"sourcesContent":["\"use server\"\n\nimport { NextRequest, NextResponse } from \"next/server\"\nimport OpenAI from \"openai\"\n\nconst apiKey = process.env.DEEPSEEK_API_KEY\nconst baseURL = process.env.DEEPSEEK_BASE_URL\n\nif (!apiKey || !baseURL) {\n  console.warn(\n    \"[generate-sentences] Missing DEEPSEEK_API_KEY or DEEPSEEK_BASE_URL. AI 生成功能将不可用。\",\n  )\n}\n\nconst client =\n  apiKey && baseURL\n    ? new OpenAI({\n        apiKey,\n        baseURL,\n      })\n    : null\n\ntype GeneratedSentence = {\n  cn: string\n  en: string\n  words: string[]\n}\n\nexport async function POST(req: NextRequest) {\n  if (!client) {\n    return NextResponse.json(\n      { error: \"DeepSeek 未配置，请先在环境变量中设置 DEEPSEEK_API_KEY 和 DEEPSEEK_BASE_URL。\" },\n      { status: 500 },\n    )\n  }\n\n  try {\n    const body = await req.json().catch(() => ({}))\n    const topic = typeof body.topic === \"string\" && body.topic.trim() ? body.topic.trim() : \"Daily English\"\n    const countRaw = Number(body.count)\n    const count = Number.isFinite(countRaw) && countRaw > 0 && countRaw <= 50 ? countRaw : 20\n    const level =\n      typeof body.level === \"string\" && body.level.trim()\n        ? body.level.trim()\n        : \"中等难度\"\n\n    const systemPrompt = `\n你是一个专业的英语教材编写者。请根据用户提供的主题，生成 ${count} 组实用的中英对话例句。\n\n严格要求：\n- 返回纯 JSON 数组格式，不要包含 json 代码块标记，不要包含任何其他文字。\n- 数据结构必须为：[{ \"cn\": \"中文意思\", \"en\": \"English sentence\", \"words\": [\"拆分\", \"单\", \"词\"] }]\n- words 数组中，请将单词和标点符号（如 ? . ! ,）作为单独的项拆分。\n- 分词必须尽量符合英语自然拼读习惯，缩写词（如 don't, I'm, can't）作为一个整体，标点符号 (. ? ! ,) 作为单独元素。\n- 难度为：${level}，语境贴近生活和真实对话。\n`.trim()\n\n    const userPrompt = `主题 (topic): ${topic}\\n难度: ${level}\\n请生成 ${count} 组中英对话例句。`\n\n    const response = await client.chat.completions.create({\n      model: \"deepseek-chat\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: 0.7,\n    })\n\n    const rawContent = response.choices?.[0]?.message?.content ?? \"\"\n\n    // 清理可能的 ```json ``` 包裹\n    const cleaned = rawContent\n      .trim()\n      .replace(/```json/gi, \"\")\n      .replace(/```/g, \"\")\n      .trim()\n\n    let parsed: unknown\n    try {\n      parsed = JSON.parse(cleaned)\n    } catch {\n      // 尝试从文本中提取第一个 [...] JSON 数组\n      const match = cleaned.match(/\\[[\\s\\S]*\\]/)\n      if (!match) {\n        throw new Error(\"无法从模型返回中解析 JSON 数组\")\n      }\n      parsed = JSON.parse(match[0])\n    }\n\n    if (!Array.isArray(parsed)) {\n      throw new Error(\"解析结果不是 JSON 数组\")\n    }\n\n    const result: GeneratedSentence[] = parsed\n      .map((item: any) => {\n        if (!item) return null\n        const cn = typeof item.cn === \"string\" ? item.cn.trim() : \"\"\n        const en = typeof item.en === \"string\" ? item.en.trim() : \"\"\n        const wordsSource: any[] = Array.isArray(item.words) ? item.words : []\n\n        const words = wordsSource\n          .map((w) => (typeof w === \"string\" ? w.trim() : \"\"))\n          .filter(Boolean)\n\n        if (!cn || !en || words.length === 0) return null\n        return { cn, en, words }\n      })\n      .filter(Boolean) as GeneratedSentence[]\n\n    return NextResponse.json({ items: result }, { status: 200 })\n  } catch (error) {\n    console.error(\"[generate-sentences] error\", error)\n    return NextResponse.json(\n      { error: \"生成句子失败，请稍后重试。\" },\n      { status: 500 },\n    )\n  }\n}\n\n\n"],"names":[],"mappings":"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"}}]
}