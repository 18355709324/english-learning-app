<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¼å…¥æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    .status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #138496;
    }
    .course-info {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š è¯¾ç¨‹å¯¼å…¥æµ‹è¯•</h1>
    <div id="status" class="status info">å‡†å¤‡å¯¼å…¥...</div>
    
    <div class="course-info">
      <h3>è¯¾ç¨‹ä¿¡æ¯</h3>
      <p id="courseInfo">åŠ è½½ä¸­...</p>
    </div>
    
    <button onclick="importCourse()">å¯¼å…¥è¯¾ç¨‹</button>
    <button onclick="checkStorage()">æ£€æŸ¥å­˜å‚¨</button>
    <button onclick="clearStorage()">æ¸…ç©ºå­˜å‚¨</button>
    <button onclick="window.location.href='/'" style="background: #28a745;">è¿”å›é¦–é¡µ</button>
    
    <div id="result" style="margin-top: 20px;"></div>
  </div>

  <script>
    const CUSTOM_COURSES_KEY = "english-learning-custom-courses";
    let courseData = null;

    // åŠ è½½è¯¾ç¨‹æ•°æ®
    async function loadCourseData() {
      try {
        const response = await fetch('/import-course.json');
        const data = await response.json();
        courseData = data.courses[0];
        
        document.getElementById('courseInfo').innerHTML = `
          <strong>æ ‡é¢˜:</strong> ${courseData.title}<br>
          <strong>æè¿°:</strong> ${courseData.description}<br>
          <strong>é¢˜ç›®æ•°é‡:</strong> ${courseData.questions.length}<br>
          <strong>éš¾åº¦:</strong> ${courseData.level}
        `;
        
        updateStatus('è¯¾ç¨‹æ•°æ®åŠ è½½æˆåŠŸï¼', 'success');
      } catch (error) {
        updateStatus('åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥: ' + error.message, 'error');
      }
    }

    // å¯¼å…¥è¯¾ç¨‹
    function importCourse() {
      if (!courseData) {
        updateStatus('è¯·å…ˆåŠ è½½è¯¾ç¨‹æ•°æ®', 'error');
        return;
      }

      try {
        // è·å–ç°æœ‰è¯¾ç¨‹
        const existingCourses = JSON.parse(localStorage.getItem(CUSTOM_COURSES_KEY) || '[]');
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåè¯¾ç¨‹
        const existingIndex = existingCourses.findIndex(c => c.title === courseData.title);
        
        // ç”Ÿæˆè¯¾ç¨‹ID
        const courseId = `custom-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        // è§„èŒƒåŒ–è¯¾ç¨‹æ•°æ®
        const normalizedCourse = {
          id: courseId,
          title: courseData.title,
          description: courseData.description,
          icon: courseData.icon || 'ğŸ“š',
          color: courseData.color || 'from-blue-500 to-cyan-500',
          level: courseData.level || 'beginner',
          questionCount: courseData.questions.length,
          duration: calculateDuration(courseData.questions.length),
          questions: courseData.questions.map((q, idx) => ({
            id: q.id || idx + 1,
            chinese: q.chinese || q.cn || '',
            english: q.english || q.en || '',
            words: q.words || []
          })),
          status: 'in-progress',
          progress: 0
        };

        if (existingIndex >= 0) {
          // æ›´æ–°ç°æœ‰è¯¾ç¨‹
          existingCourses[existingIndex] = normalizedCourse;
          updateStatus('è¯¾ç¨‹å·²æ›´æ–°ï¼', 'success');
        } else {
          // æ·»åŠ æ–°è¯¾ç¨‹
          existingCourses.push(normalizedCourse);
          updateStatus('è¯¾ç¨‹å¯¼å…¥æˆåŠŸï¼', 'success');
        }

        // ä¿å­˜åˆ°localStorage
        localStorage.setItem(CUSTOM_COURSES_KEY, JSON.stringify(existingCourses));
        
        document.getElementById('result').innerHTML = `
          <div class="status success">
            <h3>âœ… å¯¼å…¥æˆåŠŸï¼</h3>
            <p>è¯¾ç¨‹å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨</p>
            <p><strong>è¯¾ç¨‹ID:</strong> ${courseId}</p>
            <p><strong>é¢˜ç›®æ•°é‡:</strong> ${normalizedCourse.questionCount}</p>
          </div>
        `;
        
        checkStorage();
      } catch (error) {
        updateStatus('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
        console.error(error);
      }
    }

    // æ£€æŸ¥å­˜å‚¨
    function checkStorage() {
      const courses = JSON.parse(localStorage.getItem(CUSTOM_COURSES_KEY) || '[]');
      const resultDiv = document.getElementById('result');
      
      if (courses.length === 0) {
        resultDiv.innerHTML = '<div class="status info">å­˜å‚¨ä¸­è¿˜æ²¡æœ‰è¯¾ç¨‹</div>';
      } else {
        resultDiv.innerHTML = `
          <div class="status success">
            <h3>ğŸ“¦ å­˜å‚¨ä¸­çš„è¯¾ç¨‹ (${courses.length})</h3>
            <ul>
              ${courses.map(c => `<li><strong>${c.title}</strong> - ${c.questionCount} é“é¢˜</li>`).join('')}
            </ul>
          </div>
        `;
      }
    }

    // æ¸…ç©ºå­˜å‚¨
    function clearStorage() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è‡ªå®šä¹‰è¯¾ç¨‹å—ï¼Ÿ')) {
        localStorage.removeItem(CUSTOM_COURSES_KEY);
        updateStatus('å­˜å‚¨å·²æ¸…ç©º', 'info');
        checkStorage();
      }
    }

    // è®¡ç®—æ—¶é•¿
    function calculateDuration(questionCount) {
      const minutes = Math.ceil((questionCount * 30) / 60);
      return `${minutes} min`;
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è¯¾ç¨‹æ•°æ®å¹¶å¯¼å…¥
    async function autoImport() {
      await loadCourseData();
      setTimeout(() => {
        importCourse();
        setTimeout(() => {
          updateStatus('âœ… è‡ªåŠ¨å¯¼å…¥å®Œæˆï¼å¯ä»¥è¿”å›é¦–é¡µæŸ¥çœ‹è¯¾ç¨‹äº†', 'success');
        }, 500);
      }, 1000);
    }
    
    // è‡ªåŠ¨æ‰§è¡Œå¯¼å…¥
    autoImport();
  </script>
</body>
</html>

